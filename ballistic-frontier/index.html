<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ballistic Frontier | DEFINITIVE RESTORATION</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --desert: #f1c40f;
            --arctic: #ecf0f1;
            --urban: #2ecc71;
            --ui: rgba(255, 255, 255, 0.98);
        }

        body {
            margin: 0;
            background: #2c3e50;
            overflow: hidden;
            font-family: 'Fredoka One', cursive;
            user-select: none;
        }

        canvas {
            display: block;
        }

        /* INTERFACE LAYERING */
        #ui-layer {
            position: absolute;
            inset: 0;
            z-index: 5000;
            pointer-events: none;
        }

        #ui-layer>* {
            pointer-events: auto;
        }

        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle, #34495e, #2c3e50);
            z-index: 9000;
            color: #fff;
        }

        /* HUD & STATS */
        #game-hud {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 15px;
            pointer-events: none;
            z-index: 6000;
        }

        .stat-card {
            background: var(--ui);
            border: 4px solid #000;
            padding: 12px 24px;
            border-radius: 16px;
            color: #000;
            box-shadow: 6px 6px 0 rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            display: block;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        /* BUTTONS */
        .btn {
            padding: 18px 40px;
            font-size: 1.5rem;
            cursor: pointer;
            border: 4px solid #000;
            border-radius: 20px;
            font-family: inherit;
            transition: 0.1s;
            box-shadow: 0 8px 0 #000;
            background: #fff;
            color: #000;
        }

        .btn:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #000;
        }

        .btn:hover {
            background: #f8f8f8;
        }

        .map-btn[data-map="desert"] {
            background: var(--desert);
        }

        .map-btn[data-map="arctic"] {
            background: var(--arctic);
        }

        .map-btn[data-map="grassland"] {
            background: var(--urban);
            color: #fff;
        }

        /* ARSENAL */
        #arsenal-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            width: 85%;
            max-height: 60vh;
            overflow-y: auto;
            padding: 20px;
        }

        .arsenal-card {
            background: #fff;
            color: #000;
            border: 4px solid #000;
            padding: 20px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            position: relative;
            transition: 0.2s;
        }

        .arsenal-card.equipped {
            border-color: #2ecc71;
            background: #eaffea;
            transform: scale(1.05);
        }

        .arsenal-card.equipped::after {
            content: 'âœ“ READY';
            position: absolute;
            top: -12px;
            right: -12px;
            background: #2ecc71;
            color: #fff;
            padding: 5px 12px;
            border-radius: 8px;
            border: 3px solid #000;
            font-size: 0.8rem;
        }

        /* TOWER BAR */
        #tower-bar {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 25px;
            z-index: 6000;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .tower-slot {
            background: #fff;
            border: 4px solid #000;
            padding: 12px;
            border-radius: 15px;
            cursor: pointer;
            min-width: 95px;
            text-align: center;
        }

        .tower-slot.selected {
            background: #f1c40f;
            transform: translateY(-12px);
            box-shadow: 0 12px 0 rgba(0, 0, 0, 0.4);
        }

        .tower-slot .t-name {
            font-size: 0.75rem;
            color: #666;
            display: block;
            text-transform: uppercase;
        }

        .tower-slot .t-cost {
            font-size: 1.3rem;
            font-weight: bold;
        }

        #start-wave-btn {
            position: absolute;
            top: 25px;
            right: 25px;
            background: #e74c3c;
            color: #fff;
            border-radius: 60px;
            padding: 20px 50px;
            font-size: 1.8rem;
            display: none;
            z-index: 7000;
        }

        #upgrade-panel {
            position: absolute;
            bottom: 150px;
            right: 30px;
            background: #fff;
            border: 5px solid #000;
            border-radius: 20px;
            padding: 25px;
            width: 220px;
            display: none;
            z-index: 6000;
            box-shadow: 10px 10px 0 rgba(0, 0, 0, 0.3);
        }

        #upgrade-panel button {
            width: 100%;
            border: 3px solid #000;
            padding: 12px;
            font-family: inherit;
            font-weight: bold;
            border-radius: 12px;
            margin-top: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="ui-layer">
        <!-- MAIN MENU -->
        <div id="main-menu" class="screen">
            <h1 style="font-size: 5rem; margin: 0; text-shadow: 8px 8px 0 #000; letter-spacing: -2px;">BALLISTIC
                FRONTIER</h1>
            <p style="letter-spacing: 6px; color: #f1c40f; margin-bottom: 50px; font-size: 1.2rem;">THE DEFINITIVE
                RESTORATION</p>
            <div id="menu-gold" class="stat-card"
                style="font-size: 2.5rem; border-color: #f1c40f; margin-bottom: 35px;">GOLD: 0</div>
            <div id="map-select" style="display: flex; gap: 20px; margin-bottom: 40px;">
                <button class="btn map-btn" data-map="desert">DESERT</button>
                <button class="btn map-btn" data-map="arctic">ARCTIC</button>
                <button class="btn map-btn" data-map="grassland">URBAN</button>
            </div>
            <button id="open-arsenal" class="btn"
                style="background: #9b59b6; color: #fff; width: 300px;">ARSENAL</button>
        </div>

        <!-- ARSENAL -->
        <div id="arsenal-screen" class="screen" style="display: none; padding: 50px;">
            <h2 style="font-size: 4rem; margin-top: 0;">ARSENAL TOGGLE</h2>
            <div id="arsenal-gold" class="stat-card" style="margin-bottom: 30px; color: #f1c40f;">GOLD: 0</div>
            <div id="arsenal-grid"></div>
            <button id="close-arsenal" class="btn"
                style="margin-top: 40px; background: #7f8c8d; color: #fff; width: 250px;">DONE</button>
        </div>

        <!-- HUD -->
        <div id="game-hud" style="display: none;">
            <div class="stat-card"><span class="stat-label">CREDITS</span><span id="cash-val"
                    class="stat-value">$600</span></div>
            <div class="stat-card"><span class="stat-label">WAVE</span><span id="wave-val" class="stat-value">0</span>
            </div>
            <div class="stat-card"><span class="stat-label">LIVES</span><span id="lives-val"
                    class="stat-value">25</span></div>
        </div>

        <div id="tower-bar" style="display: none;"></div>

        <div id="upgrade-panel">
            <h3 id="up-title" style="margin:0; font-size: 2rem;">UNIT</h3>
            <p id="up-stats" style="margin: 10px 0; color: #666; font-size: 1.1rem;">LVL 1 | DMG 10</p>
            <button id="upgrade-btn" style="background: #2ecc71; color: #fff;">UPGRADE ($200)</button>
            <button id="sell-btn" style="background: #e74c3c; color: #fff;">SELL UNIT</button>
            <button id="close-up-panel" style="background: #ddd; border-color: #999; font-size: 0.9rem;">BACK</button>
        </div>

        <button id="start-wave-btn" class="btn">START WAVE</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        (function () {
            "use strict";

            // --- GLOBAL STATE ---
            let pulse = 0;

            // --- MAP DATA ---
            const MISSION_MAPS = {
                desert: { bg: '#f1c40f', path: '#d35400', waypoints: [{ x: 0, y: 0.5 }, { x: 0.3, y: 0.5 }, { x: 0.3, y: 0.2 }, { x: 0.7, y: 0.2 }, { x: 0.7, y: 0.8 }, { x: 1, y: 0.8 }] },
                arctic: { bg: '#fdfdfd', path: '#3498db', waypoints: [{ x: 0.1, y: 0 }, { x: 0.1, y: 0.8 }, { x: 0.5, y: 0.8 }, { x: 0.5, y: 0.2 }, { x: 0.9, y: 0.2 }, { x: 0.9, y: 1 }] },
                grassland: { bg: '#2ecc71', path: '#ecf0f1', waypoints: [{ x: 0, y: 0.2 }, { x: 0.5, y: 0.2 }, { x: 0.5, y: 0.5 }, { x: 0.2, y: 0.5 }, { x: 0.2, y: 0.8 }, { x: 1, y: 0.8 }] }
            };

            const TOWER_TYPES = {
                turret: { name: "TURRET", cost: 60, gold: 0, c: '#e67e22', stats: { r: 160, d: 12, rate: 600 } },
                sniper: { name: "SNIPER", cost: 130, gold: 0, c: '#9b59b6', stats: { r: 360, d: 50, rate: 2000 } },
                minigun: { name: "MINIGUN", cost: 260, gold: 500, c: '#f1c40f', stats: { r: 190, d: 8, rate: 100 } },
                cannon: { name: "CANNON", cost: 350, gold: 1000, c: '#34495e', stats: { r: 220, d: 80, rate: 1800 } },
                missile: { name: "MISSILE", cost: 550, gold: 2000, c: '#e74c3c', stats: { r: 450, d: 120, rate: 3500 } },
                ice: { name: "FROSTER", cost: 200, gold: 0, c: '#00d2ff', stats: { r: 150, d: 5, rate: 1200 } },
                bank: { name: "BANK", cost: 800, gold: 4000, c: '#ffd700', stats: { r: 0, d: 0, rate: 0 } }
            };

            const ENEMY_TYPES = {
                grunt: { hp: 60, s: 0.00016, gold: 1, c: '#d35400', size: 15 },
                runner: { hp: 40, s: 0.00038, gold: 1, c: '#f1c40f', size: 12 },
                heavy: { hp: 500, s: 0.0001, gold: 12, c: '#2ecc71', size: 22 },
                boss: { hp: 20000, s: 0.000035, gold: 300, c: '#000', size: 55 }
            };

            // --- RENDER HELPERS (HEAVY DETAIL) ---
            const drawMetal = (ctx, x1, y1, x2, y2) => {
                const grad = ctx.createLinearGradient(x1, y1, x2, y2);
                grad.addColorStop(0, '#555'); grad.addColorStop(0.5, '#AAA'); grad.addColorStop(1, '#555'); return grad;
            };

            const drawBase = (ctx, t) => {
                ctx.fillStyle = drawMetal(ctx, -22, -22, 22, 22);
                ctx.beginPath(); for (let i = 0; i < 6; i++) { const a = i * Math.PI / 3; ctx.lineTo(Math.cos(a) * 22, Math.sin(a) * 22); } ctx.closePath(); ctx.fill(); ctx.stroke();
                const opacity = 0.3 + (Math.sin(pulse / 10) + 1) * 0.35; ctx.fillStyle = `rgba(0,255,100,${opacity})`; ctx.fillRect(-12, -12, 6, 6);
            };

            TOWER_TYPES.turret.draw = (ctx, t) => {
                const lv = t ? t.lvl : 1; drawBase(ctx, t); ctx.fillStyle = TOWER_TYPES.turret.c; ctx.beginPath(); ctx.arc(0, 0, 15, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#333'; ctx.fillRect(0, -6, 28 + lv * 4, 12); ctx.strokeRect(0, -6, 28 + lv * 4, 12);
            };
            TOWER_TYPES.sniper.draw = (ctx, t) => {
                const lv = t ? t.lvl : 1; drawBase(ctx, t); ctx.fillStyle = drawMetal(ctx, -15, -15, 15, 15); ctx.beginPath(); ctx.moveTo(-18, -18); ctx.lineTo(18, 0); ctx.lineTo(-18, 18); ctx.closePath(); ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#000'; ctx.fillRect(0, -4, 60 + lv * 8, 8); ctx.strokeRect(0, -4, 60 + lv * 8, 8);
            };
            TOWER_TYPES.minigun.draw = (ctx, t) => {
                const lv = t ? t.lvl : 1; drawBase(ctx, t); ctx.rotate(pulse / 3);
                for (let i = 0; i < 3; i++) { ctx.rotate(Math.PI * 2 / 3); ctx.fillStyle = '#333'; ctx.fillRect(12, -5, 24 + lv * 4, 10); ctx.strokeRect(12, -5, 24 + lv * 4, 10); }
            };
            TOWER_TYPES.cannon.draw = (ctx, t) => {
                const lv = t ? t.lvl : 1; drawBase(ctx, t); ctx.fillStyle = drawMetal(ctx, -20, -18, 10, 22); ctx.fillRect(-20, -18, 36, 36); ctx.strokeRect(-20, -18, 36, 36);
                ctx.fillStyle = '#333'; ctx.fillRect(10, -15, 38 + lv * 6, 30); ctx.strokeRect(10, -15, 38 + lv * 6, 30);
            };
            TOWER_TYPES.missile.draw = (ctx, t) => {
                const lv = t ? t.lvl : 1; drawBase(ctx, t); ctx.fillStyle = drawMetal(ctx, -22, -22, 22, 22); ctx.fillRect(-22, -22, 44, 44); ctx.strokeRect(-22, -22, 44, 44);
                ctx.fillStyle = '#e74c3c'; for (let i = -1; i <= 1; i += 2) for (let j = -1; j <= 1; j += 2) { ctx.beginPath(); ctx.arc(i * 10, j * 10, 7 + lv, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); }
            };
            TOWER_TYPES.ice.draw = (ctx, t) => {
                const lv = t ? t.lvl : 1; drawBase(ctx, t); ctx.fillStyle = '#00d2ff'; ctx.beginPath(); ctx.moveTo(0, -20); ctx.lineTo(20, 0); ctx.lineTo(0, 20); ctx.lineTo(-20, 0); ctx.closePath(); ctx.fill(); ctx.stroke();
                const sz = (Math.sin(pulse / 5) + 1) * 3; ctx.strokeStyle = '#fff'; ctx.beginPath(); ctx.arc(0, 0, 10 + sz, 0, Math.PI * 2); ctx.stroke();
            };
            TOWER_TYPES.bank.draw = (ctx, t) => {
                drawBase(ctx, t); ctx.fillStyle = '#2ecc71'; ctx.font = 'bold 28px Arial'; ctx.fillText('$', -8, 10);
            };

            // --- SESSION MANAGEMENT ---
            class SessionManager {
                constructor() { this.gold = 0; this.unlocks = ['turret', 'sniper', 'ice']; this.loadout = ['turret', 'sniper', 'ice']; this.omniScan(); }
                omniScan() {
                    const keys = ['bf_save_v4', 'bf_save_v3', 'bf_save_v2', 'bf_save_v1', 'ballistic_frontier_save', 'player_data'];
                    let bestGold = 0; let totalUnlocks = new Set(this.unlocks);
                    keys.forEach(k => {
                        const data = localStorage.getItem(k);
                        if (data) {
                            try {
                                const d = JSON.parse(data);
                                if (d && d.gold > bestGold) bestGold = d.gold;
                                if (d && d.unlocks) d.unlocks.forEach(u => { if (TOWER_TYPES[u]) totalUnlocks.add(u); });
                            } catch (e) { }
                        }
                    });
                    this.gold = bestGold; this.unlocks = Array.from(totalUnlocks); this.sanitize(); this.persist();
                }
                sanitize() {
                    this.unlocks = this.unlocks.filter(id => TOWER_TYPES[id]);
                    this.loadout = this.loadout.filter(id => TOWER_TYPES[id]);
                    if (this.loadout.length === 0) this.loadout = ['turret', 'sniper', 'ice'];
                }
                persist() { localStorage.setItem('bf_save_v4', JSON.stringify({ gold: this.gold, unlocks: this.unlocks, loadout: this.loadout })); }
            }

            // --- GAME ENGINE ---
            class GameInstance {
                constructor() {
                    this.canvas = document.getElementById('gameCanvas'); this.ctx = this.canvas.getContext('2d');
                    this.sm = new SessionManager(); this.towers = []; this.enemies = []; this.projs = [];
                    this.cash = 600; this.lives = 25; this.wave = 0; this.active = false; this.waveActive = false;
                    this.queue = []; this.spawnTimer = 0; this.map = MISSION_MAPS.desert;
                    this.resize(); this.initEvents(); this.runLoop();
                }
                resize() { this.w = window.innerWidth; this.h = window.innerHeight; this.canvas.width = this.w; this.canvas.height = this.h; }
                initEvents() {
                    const find = (id) => document.getElementById(id);
                    document.querySelectorAll('.map-btn').forEach(b => b.onclick = () => this.start(b.dataset.map));
                    find('open-arsenal').onclick = () => { find('main-menu').style.display = 'none'; find('arsenal-screen').style.display = 'flex'; this.renderArsenal(); };
                    find('close-arsenal').onclick = () => { find('arsenal-screen').style.display = 'none'; find('main-menu').style.display = 'flex'; this.updateStats(); };
                    find('start-wave-btn').onclick = () => this.triggerWave();
                    find('upgrade-btn').onclick = () => { if (this.selT && this.cash >= 200) { this.cash -= 200; this.selT.lvl++; this.selT.dmg *= 1.5; this.updateUpPanel(); this.updateStats(); } };
                    find('sell-btn').onclick = () => { if (this.selT) { this.cash += TOWER_TYPES[this.selT.type].cost * 0.5; this.towers = this.towers.filter(t => t !== this.selT); find('upgrade-panel').style.display = 'none'; this.selT = null; this.updateStats(); } };
                    find('close-up-panel').onclick = () => { find('upgrade-panel').style.display = 'none'; this.selT = null; };
                    this.updateStats();
                }
                updateStats() {
                    const map = { 'menu-gold': `GOLD: ${Math.floor(this.sm.gold)}`, 'arsenal-gold': `GOLD: ${Math.floor(this.sm.gold)}`, 'cash-val': `$${Math.floor(this.cash)}`, 'wave-val': this.wave, 'lives-val': this.lives };
                    Object.entries(map).forEach(([id, val]) => { const el = document.getElementById(id); if (el) el.innerText = val; });
                }
                renderArsenal() {
                    const grid = document.getElementById('arsenal-grid'); grid.innerHTML = '';
                    Object.keys(TOWER_TYPES).forEach(id => {
                        const d = TOWER_TYPES[id]; const card = document.createElement('div'); card.className = 'arsenal-card';
                        if (this.sm.loadout.includes(id)) card.classList.add('equipped');
                        card.innerHTML = `<strong>${d.name}</strong><br><small>Unlock: ${d.gold}</small>`;
                        card.onclick = () => {
                            const owns = this.sm.unlocks.includes(id);
                            if (!owns) { if (this.sm.gold >= d.gold) { this.sm.gold -= d.gold; this.sm.unlocks.push(id); } }
                            else {
                                if (this.sm.loadout.includes(id)) this.sm.loadout = this.sm.loadout.filter(x => x !== id);
                                else { this.sm.loadout.push(id); if (this.sm.loadout.length > 10) this.sm.loadout.shift(); }
                            }
                            this.sm.persist(); this.renderArsenal(); this.updateStats();
                        };
                        grid.appendChild(card);
                    });
                }
                start(m) {
                    this.map = MISSION_MAPS[m]; this.active = true;
                    document.getElementById('main-menu').style.display = 'none'; document.getElementById('game-hud').style.display = 'flex';
                    document.getElementById('start-wave-btn').style.display = 'block';
                    const bar = document.getElementById('tower-bar'); bar.style.display = 'flex'; bar.innerHTML = '';
                    this.sm.loadout.forEach(id => {
                        if (!TOWER_TYPES[id]) return;
                        const slot = document.createElement('div'); slot.className = 'tower-slot';
                        slot.innerHTML = `<span class="t-name">${TOWER_TYPES[id].name}</span><span class="t-cost">$${TOWER_TYPES[id].cost}</span>`;
                        slot.onclick = () => { document.querySelectorAll('.tower-slot').forEach(x => x.classList.remove('selected')); slot.classList.add('selected'); this.placementId = id; };
                        bar.appendChild(slot);
                    });
                }
                triggerWave() {
                    if (this.waveActive) return; this.wave++; this.waveActive = true; this.spawnTimer = 0;
                    const pool = ['grunt', 'grunt', 'runner', 'heavy']; const count = 10 + this.wave * 5;
                    for (let i = 0; i < count; i++) this.queue.push(pool[Math.floor(Math.random() * pool.length)]);
                    if (this.wave % 10 === 0) this.queue.push('boss');
                    document.getElementById('start-wave-btn').style.display = 'none'; this.updateStats();
                }
                runLoop() {
                    const frame = (t) => {
                        const dt = t - (this.lastTime || t); this.lastTime = t; pulse++;
                        if (this.active) { this.update(dt); this.render(); }
                        requestAnimationFrame(frame);
                    };
                    requestAnimationFrame(frame);
                }
                update(dt) {
                    if (this.waveActive) {
                        if (this.queue.length > 0) {
                            this.spawnTimer += dt; if (this.spawnTimer >= Math.max(100, 1000 - this.wave * 40)) { this.spawnTimer = 0; const kid = this.queue.shift(); const d = ENEMY_TYPES[kid]; this.enemies.push({ type: kid, hp: d.hp, max: d.hp, x: this.map.waypoints[0].x, y: this.map.waypoints[0].y, idx: 0, prog: 0 }); }
                        } else if (this.enemies.length === 0) { this.waveActive = false; document.getElementById('start-wave-btn').style.display = 'block'; const bCount = this.towers.filter(t => t.type === 'bank').length; this.cash += bCount * 100; this.updateStats(); }
                    }
                    this.enemies = this.enemies.filter(e => {
                        const d = ENEMY_TYPES[e.type]; e.prog += d.s * dt; if (e.prog >= 1) { e.prog = 0; e.idx++; if (e.idx >= this.map.waypoints.length - 1) { this.lives--; this.updateStats(); return false; } }
                        const a = this.map.waypoints[e.idx], b = this.map.waypoints[e.idx + 1]; e.x = a.x + (b.x - a.x) * e.prog; e.y = a.y + (b.y - a.y) * e.prog; return e.hp > 0;
                    });
                    this.towers.forEach(t => {
                        t.cd = (t.cd || 0) + dt; const d = TOWER_TYPES[t.type];
                        if (d.stats.rate && t.cd >= d.stats.rate) {
                            const target = this.enemies.find(e => Math.sqrt((e.x * this.w - t.x) ** 2 + (e.y * this.h - t.y) ** 2) <= d.stats.r);
                            if (target) { t.cd = 0; this.projs.push({ x: t.x, y: t.y, target: target, dmg: t.dmg, type: t.type, c: d.c }); }
                        }
                    });
                    this.projs = this.projs.filter(p => {
                        if (!p.target || p.target.hp <= 0) return false;
                        const tx = p.target.x * this.w, ty = p.target.y * this.h, dx = tx - p.x, dy = ty - p.y, dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < 15) { p.target.hp -= p.dmg; if (p.target.hp <= 0) { this.sm.gold += ENEMY_TYPES[p.target.type].gold; this.cash += 4; this.sm.persist(); this.updateStats(); } return false; }
                        p.x += dx / dist * 0.75 * dt; p.y += dy / dist * 0.75 * dt; return true;
                    });
                    if (this.lives <= 0) { alert("CORE BREACHED. RETREATING."); location.reload(); }
                }
                render() {
                    this.ctx.fillStyle = this.map.bg; this.ctx.fillRect(0, 0, this.w, this.h);
                    this.ctx.strokeStyle = this.map.path; this.ctx.lineWidth = 75; this.ctx.lineCap = 'round'; this.ctx.lineJoin = 'round'; this.ctx.beginPath();
                    this.map.waypoints.forEach((p, i) => (i === 0) ? this.ctx.moveTo(p.x * this.w, p.y * this.h) : this.ctx.lineTo(p.x * this.w, p.y * this.h)); this.ctx.stroke();
                    this.enemies.forEach(e => {
                        const d = ENEMY_TYPES[e.type]; this.ctx.fillStyle = d.c; this.ctx.beginPath(); this.ctx.arc(e.x * this.w, e.y * this.h, d.size, 0, Math.PI * 2); this.ctx.fill(); this.ctx.stroke();
                        this.ctx.fillStyle = '#300'; this.ctx.fillRect(e.x * this.w - 15, e.y * this.h - 25, 30, 6);
                        this.ctx.fillStyle = '#0f0'; this.ctx.fillRect(e.x * this.w - 15, e.y * this.h - 25, 30 * (e.hp / e.max), 6);
                    });
                    this.towers.forEach(t => {
                        if (!TOWER_TYPES[t.type]) return;
                        this.ctx.save(); this.ctx.translate(t.x, t.y); TOWER_TYPES[t.type].draw(this.ctx, t); this.ctx.restore();
                    });
                    this.projs.forEach(p => { this.ctx.fillStyle = p.c; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 8, 0, Math.PI * 2); this.ctx.fill(); this.ctx.stroke(); });
                }
                updateUpPanel() {
                    if (!this.selT) return; document.getElementById('up-title').innerText = this.selT.type.toUpperCase();
                    document.getElementById('up-stats').innerText = `LVL ${this.selT.lvl} | FORCE ${Math.floor(this.selT.dmg)}`;
                }
            }

            const game = new GameInstance();
            window.onclick = (e) => {
                if (!game.active || e.target.tagName !== 'CANVAS') return;
                const t = game.towers.find(x => Math.sqrt((x.x - e.clientX) ** 2 + (x.y - e.clientY) ** 2) < 35);
                if (t) { game.selT = t; document.getElementById('upgrade-panel').style.display = 'block'; game.updateUpPanel(); }
                else if (game.placementId) {
                    const cost = TOWER_TYPES[game.placementId].cost;
                    if (game.cash >= cost) { game.cash -= cost; game.towers.push({ type: game.placementId, x: e.clientX, y: e.clientY, lvl: 1, dmg: TOWER_TYPES[game.placementId].stats.d }); game.updateStats(); }
                }
            };
            window.onresize = () => game.resize();
        })();
    </script>
</body>

</html>